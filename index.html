<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Regina Safety Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    /* Add your existing CSS styles here */
  </style>
</head>
<body>
  <h2>Regina Safety Map</h2>
  <div class="container">
    <div class="box">
      <div id="map"></div>
    </div>
    <div class="box">
      <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSdWj35cPdCx9fsBj20PNxGfaxRc2J1waQrvF0oV_KjrPrarUg/viewform?embedded=true">Loadingâ€¦</iframe>
    </div>
  </div>

  <script>
    // Initialize the map
    const map = L.map('map').setView([50.4454, -104.6185], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const sheetID = '1kcR6ZqQ0YN2E-G0uTS3mz_pFXoAa4N3CUYslbzCFw5M';
    const apiKey = 'AIzaSyCgM-QmovG5LFPRwOGd_ZD_dygszYkFByI';
    const range = 'Form Responses 1';
    const sheetURL = `https://sheets.googleapis.com/v4/spreadsheets/${sheetID}/values/${range}?key=${apiKey}`;

    // Indigenous Historical Locations
    const indigenousSites = [
      { name: "Treaty 4 Governance Centre", lat: 50.6506, lng: -104.6453, description: "A center dedicated to Treaty 4 governance and history.", link: "https://www.treaty4.ca/" },
      { name: "First Nations University of Canada", lat: 50.4309, lng: -104.6174, description: "Offers Indigenous-focused education and cultural events.", link: "https://www.fnuniv.ca/" },
      { name: "Royal Saskatchewan Museum", lat: 50.4418, lng: -104.6066, description: "Features Indigenous exhibits and history of the land.", link: "https://royalsaskmuseum.ca/" }
    ];

    function addHistoricalMarkers() {
      indigenousSites.forEach(site => {
        var marker = L.marker([site.lat, site.lng]).addTo(map);
        marker.bindPopup(`<b>${site.name}</b><br>${site.description}<br><a href="${site.link}" target="_blank">Learn More</a>`);
      });
    }

    async function fetchSafetyReports() {
      try {
        const response = await fetch(sheetURL);
        const data = await response.json();

        if (!data.values || data.values.length < 2) {
          console.error("No valid data found.");
          return;
        }
        console.log("Fetched Data:", data);
        const rows = data.values.slice(1);
        rows.forEach(async (row) => {
          const locationName = row[1];
          const safetyStatus = row[2];
          const notes = row[3] || "No additional notes";
          const { lat, lng } = await getCoordinates(locationName);
          if (lat && lng) {
            addMarker(lat, lng, locationName, safetyStatus, notes);
          } else {
            console.warn(`No coordinates found for ${locationName}`);
          }
        });
      } catch (error) {
        console.error("Error fetching data:", error);
      }
    }

    // Delay function for waiting between retries
    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Retry request with exponential backoff
    async function retryRequest(url, retries = 5, delayTime = 1000) {
      for (let attempt = 0; attempt < retries; attempt++) {
        const response = await fetch(url);
        if (response.status === 429) {
          console.log(`Rate limit hit, retrying in ${delayTime / 1000}s...`);
          await delay(delayTime);
          delayTime *= 2;  // Exponential backoff
        } else {
          return response.json();  // Successful response
        }
      }
      throw new Error('Max retries reached');
    }

    // Use retryRequest in getCoordinates function
    async function getCoordinates(locationName) {
      const corsProxy = "https://cors-anywhere.herokuapp.com/";
      const url = `${corsProxy}https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationName + ', Regina, Saskatchewan')}`;

      try {
        const data = await retryRequest(url);  // Call retryRequest function
        console.log(`Response for ${locationName}:`, data);

        if (data.length > 0) {
          return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
        }
      } catch (error) {
        console.error("Error fetching coordinates:", error);
      }
      return { lat: null, lng: null };
    }

    function addMarker(lat, lng, locationName, safetyStatus, notes) {
      var marker = L.marker([lat, lng]).addTo(map);
      marker.bindPopup(`<b>${locationName}</b><br>Safety Status: ${safetyStatus}<br>${notes}`);
    }

    fetchSafetyReports();
  </script>

  <!-- Bootstrap JS (Optional) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
