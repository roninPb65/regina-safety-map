<!DOCTYPE html>
<html>
<head>
  <title>Regina Safety Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>
    <h2>Regina Safety Map</h2>
    <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSdWj35cPdCx9fsBj20PNxGfaxRc2J1waQrvF0oV_KjrPrarUg/viewform?embedded=true" width="640" height="480">Loadingâ€¦</iframe>
    <div id="map" style="height: 500px;"></div>

    <script>
        // Initialize the map
        const map = L.map('map').setView([50.4454, -104.6185], 12); // Regina's coordinates
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const sheetID = '1kcR6ZqQ0YN2E-G0uTS3mz_pFXoAa4N3CUYslbzCFw5M'; // Google Sheet ID
        const apiKey = 'AIzaSyCgM-QmovG5LFPRwOGd_ZD_dygszYkFByI';  // Your API key
        const range = 'Form Responses 1';  // Sheet name (no quotes needed)

        const sheetURL = `https://sheets.googleapis.com/v4/spreadsheets/${sheetID}/values/${range}?key=${apiKey}`;

        // Fetch data from Google Sheets
        async function fetchSafetyReports() {
            try {
                const response = await fetch(sheetURL);
                const data = await response.json();

                if (!data.values || data.values.length < 2) {
                    console.error("No valid data found.");
                    return;
                }

                console.log("Fetched Data:", data); // Debugging

                const rows = data.values.slice(1); // Skip header row

                rows.forEach(row => {
                    const timestamp = row[0]; // Timestamp (not used)
                    const locationName = row[1]; // Location Name
                    const safetyStatus = row[2]; // Safety Status
                    const notes = row[3] || "No additional notes"; // Additional Notes (Optional)
                    
                    // Use random or default lat/lng since the sheet doesn't have coordinates
                    const lat = 50.4454 + (Math.random() - 0.5) * 0.02;
                    const lng = -104.6185 + (Math.random() - 0.5) * 0.02;

                    addMarker(lat, lng, locationName, safetyStatus, notes);
                });
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        // Function to add markers to the map
        function addMarker(lat, lng, locationName, safetyStatus, notes) {
            var marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup(`<b>${locationName}</b><br>Safety Status: ${safetyStatus}<br>${notes}`);
        }

        // Call the function to fetch and display safety reports
        fetchSafetyReports();
    </script>
</body>
</html>
