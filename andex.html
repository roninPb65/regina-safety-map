<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Regina Safety Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <link rel="manifest" href="manifest.json">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      background: url(Saskatchewan-Provincial-Legislative-Building-in-Wascana-Centre.jpg);
      background-position: center;
      background-attachment: fixed;
      background-size: cover;
    }
    h2 {
      text-align: center;
      margin: 20px 0;
      font-size: 45px;
      color: #676c70fc;
      text-shadow: 1px 2px 9px #fcfcfc5c;
      background-color: #f0f8ffb5;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f6f9;
    }
    h2 {
      text-align: center;
      margin: 20px 0;
      color: #2d3e50;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .box {
      flex: 1;
      min-width: 300px;
      padding: 10px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    iframe {
      width: 100%;
      height: 480px;
      border: none;
      border-radius: 8px;
    }
    #map {
      height: 500px;
      width: 100%;
      border-radius: 8px;
    }
    .btn {
      background-color: #0069d9;
      color: white;
      border-radius: 5px;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .btn:hover {
      background-color: #0056b3;
    }
    .box {
      background-color: #25242447;
    }

    /* Chatbot styles */
    .chat-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      background-color: #ffffff;
      z-index: 999;
    }
    .chat-header {
      background-color: #0069d9;
      color: white;
      padding: 10px;
      text-align: center;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
    }
    .chat-body {
      padding: 10px;
      height: 250px;
      overflow-y: auto;
      border-bottom: 1px solid #eee;
    }
    .chat-input {
      padding: 10px;
      width: calc(100% - 20px);
      border: none;
      border-top: 1px solid #eee;
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
    }
    .chat-message {
      margin: 10px 0;
    }
    .bot-message {
      background-color: #f1f1f1;
      padding: 5px;
      border-radius: 5px;
    }
    .user-message {
      background-color: #0069d9;
      color: white;
      padding: 5px;
      border-radius: 5px;
      text-align: right;
    }
  </style>
</head>
<body>
    <h2>Regina Safety Map</h2>
    <div class="container">
        <div class="box">
            <div id="map"></div>
        </div>
        <div class="box">
            <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSdWj35cPdCx9fsBj20PNxGfaxRc2J1waQrvF0oV_KjrPrarUg/viewform?embedded=true">Loadingâ€¦</iframe>
        </div>
    </div>

    <!-- Chatbot Container -->
    <div class="chat-container">
      <div class="chat-header">Chatbot</div>
      <div class="chat-body" id="chat-body">
        <div class="chat-message bot-message">Hello! How can I assist you today?</div>
      </div>
      <input type="text" class="chat-input" id="user-input" placeholder="Type a message..." onkeydown="handleUserInput(event)">
    </div>

    <script>
        // Initialize the map
        const map = L.map('map').setView([50.4454, -104.6185], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const sheetID = '1kcR6ZqQ0YN2E-G0uTS3mz_pFXoAa4N3CUYslbzCFw5M';
        const apiKey = 'AIzaSyCgM-QmovG5LFPRwOGd_ZD_dygszYkFByI';
        const range = 'Form Responses 1';
        const sheetURL = `https://sheets.googleapis.com/v4/spreadsheets/${sheetID}/values/${range}?key=${apiKey}`;

        // Indigenous Historical Locations
        const indigenousSites = [
            { name: "Treaty 4 Governance Centre", lat: 50.6506, lng: -104.6453, description: "A center dedicated to Treaty 4 governance and history.", link: "https://www.treaty4.ca/" },
            { name: "First Nations University of Canada", lat: 50.4309, lng: -104.6174, description: "Offers Indigenous-focused education and cultural events.", link: "https://www.fnuniv.ca/" },
            { name: "Royal Saskatchewan Museum", lat: 50.4418, lng: -104.6066, description: "Features Indigenous exhibits and history of the land.", link: "https://royalsaskmuseum.ca/" }
        ];

        function addHistoricalMarkers() {
            indigenousSites.forEach(site => {
                var marker = L.marker([site.lat, site.lng]).addTo(map);
                marker.bindPopup(`<b>${site.name}</b><br>${site.description}<br><a href="${site.link}" target="_blank">Learn More</a>`);
            });
        }

        async function fetchSafetyReports() {
            try {
                const response = await fetch(sheetURL);
                const data = await response.json();

                if (!data.values || data.values.length < 2) {
                    console.error("No valid data found.");
                    return;
                }
                console.log("Fetched Data:", data);
                const rows = data.values.slice(1);
                rows.forEach(async (row) => {
                    const locationName = row[1];
                    const safetyStatus = row[2];
                    const notes = row[3] || "No additional notes";
                    const { lat, lng } = await getCoordinates(locationName);
                    if (lat && lng) {
                        addMarker(lat, lng, locationName, safetyStatus, notes);
                    } else {
                        console.warn(`No coordinates found for ${locationName}`);
                    }
                });
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        async function getCoordinates(locationName) {
            const corsProxy = "https://cors-anywhere.herokuapp.com/";
            const url = `${corsProxy}https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationName + ', Regina, Saskatchewan')}`;

            try {
                const response = await fetch(url);
                if (response.status === 429) {
                    console.warn("Rate limited! Waiting before retrying...");
                    await new Promise(resolve => setTimeout(resolve, 5000)); // Wait 5 seconds
                    return getCoordinates(locationName); // Retry request
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.length > 0) {
                    return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                }
            } catch (error) {
                console.error("Error fetching coordinates:", error);
            }
            return { lat: null, lng: null };
        }

        function addMarker(lat, lng, locationName, safetyStatus, notes) {
            var marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup(`<b>${locationName}</b><br>Safety Status: ${safetyStatus}<br>${notes}`);
        }

        // Chatbot logic
        function handleUserInput(event) {
            if (event.key === 'Enter') {
                const userInput = document.getElementById('user-input').value;
                if (userInput.trim()) {
                    displayUserMessage(userInput);
                    generateBotResponse(userInput);
                }
                document.getElementById('user-input').value = '';
            }
        }

        function displayUserMessage(message) {
            const chatBody = document.getElementById('chat-body');
            const userMessage = document.createElement('div');
            userMessage.className = 'chat-message user-message';
            userMessage.textContent = message;
            chatBody.appendChild(userMessage);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function generateBotResponse(userMessage) {
            const chatBody = document.getElementById('chat-body');
            const botMessage = document.createElement('div');
            botMessage.className = 'chat-message bot-message';

            if (userMessage.toLowerCase().includes("help")) {
                botMessage.textContent = "I'm here to assist you with the Regina Safety Map. Let me know if you need any help!";
            } else if (userMessage.toLowerCase().includes("map")) {
                botMessage.textContent = "You can explore the Regina Safety Map here. Zoom in to view the safety reports!";
            } else {
                botMessage.textContent = "I'm sorry, I didn't quite get that. Can you ask something else?";
            }

            chatBody.appendChild(botMessage);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        fetchSafetyReports();




      if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js').then((registration) => {
      console.log('Service Worker registered with scope:', registration.scope);
    }).catch((error) => {
      console.error('Service Worker registration failed:', error);
    });
  });
}

    </script>

    <!-- Bootstrap JS (Optional) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
