<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regina Safety Map</title>
      <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
         body {
    background: url(Saskatchewan-Provincial-Legislative-Building-in-Wascana-Centre.jpg);
    background-position: center;
    background-attachment: fixed;
      background-size: cover;
}
    h2 {
    text-align: center;
    margin: 20px 0;
    font-size: 45px;
    color: #676c70fc;
    text-shadow: 1px 2px 9px #fcfcfc5c;
    background-color: #f0f8ffb5;
}
 
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f6f9;
    }
    h2 {
      text-align: center;
      margin: 20px 0;
      color: #2d3e50;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .box {
      flex: 1;
      min-width: 300px;
      padding: 10px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    iframe {
      width: 100%;
      height: 480px;
      border: none;
      border-radius: 8px;
    }
    #map {
      height: 500px;
      width: 100%;
      border-radius: 8px;
    }
    .btn {
      background-color: #0069d9;
      color: white;
      border-radius: 5px;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .btn:hover {
      background-color: #0056b3;
    }
    .box {
    background-color: #25242447;
}
    </style>
</head>
<body>
    <h2>Regina Safety Map</h2>
    <div class="container">
        <div class="box">
            <div id="map"></div>
        </div>
        <div class="box">
            <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSdWj35cPdCx9fsBj20PNxGfaxRc2J1waQrvF0oV_KjrPrarUg/viewform?embedded=true">Loadingâ€¦</iframe>
        </div>
    </div>

    <script>
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                "version": 8,
                "sources": {
                    "osm": {
                        "type": "raster",
                        "url": "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                        "tileSize": 256
                    }
                },
                "layers": [
                    {
                        "id": "osm-layer",
                        "type": "raster",
                        "source": "osm",
                        "paint": {}
                    }
                ]
            },
            center: [-104.6185, 50.4454],
            zoom: 12
        });

        async function fetchSafetyReports() {
            try {
                const sheetID = '1kcR6ZqQ0YN2E-G0uTS3mz_pFXoAa4N3CUYslbzCFw5M';
                const range = 'Form Responses 1';
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetID}/values/${range}?key=AIzaSyCgM-QmovG5LFPRwOGd_ZD_dygszYkFByI`);
                const data = await response.json();

                if (!data.values || data.values.length < 2) return;
                const rows = data.values.slice(1);
                rows.forEach(async (row) => {
                    const locationName = row[1];
                    const safetyStatus = row[2];
                    const notes = row[3] || "No additional notes";
                    const { lat, lng } = await getCoordinates(locationName);
                    if (lat && lng) addMarker(lat, lng, locationName, safetyStatus, notes);
                });
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        async function getCoordinates(locationName) {
            await new Promise(resolve => setTimeout(resolve, 1500));
            const url = `https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(locationName + ', Regina, Saskatchewan')}&apiKey=3bca33509e24419592f747477095d977`;
            try {
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                if (data.features && data.features.length > 0) {
                    return { lat: data.features[0].geometry.coordinates[1], lng: data.features[0].geometry.coordinates[0] };
                }
            } catch (error) {
                console.error("Error fetching coordinates:", error);
            }
            return { lat: null, lng: null };
        }

        function addMarker(lat, lng, locationName, safetyStatus, notes) {
            new maplibregl.Marker()
                .setLngLat([lng, lat])
                .setPopup(new maplibregl.Popup().setHTML(`<b>${locationName}</b><br>Safety Status: ${safetyStatus}<br>${notes}`))
                .addTo(map);
        }

        fetchSafetyReports();
    </script>
</body>
</html>
